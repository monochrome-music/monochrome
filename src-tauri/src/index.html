<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #remote-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <iframe id="remote-frame" src="https://monochrome.samidy.com"></iframe>
    
    <script type="module">
        const { invoke } = window.__TAURI__.tauri;
        const { listen } = window.__TAURI__.event;

        let debounceTimer;
        let lastState = {};

        listen('media-toggle', () => {
            const iframe = document.getElementById('remote-frame');
            iframe.contentWindow.postMessage({ type: 'MEDIA_TOGGLE' }, '*');
        });

        window.addEventListener('message', async (event) => {
            if (event.origin !== 'https://monochrome.samidy.com') return;

            const { type, data } = event.data;
            
            if (type === 'UPDATE_DISCORD_RPC') {
                const { title, artist, image, isPaused, currentSec } = data;
                
                const currentState = { title, artist, image, isPaused };
                
                if (JSON.stringify(currentState) === JSON.stringify(lastState)) {
                    return;
                }
                
                lastState = currentState;
                
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    try {
                        await invoke('update_discord_presence', {
                            details: title,
                            status: artist,
                            image: image,
                            isPaused: isPaused,
                            currentSec: currentSec
                        });
                        console.log('[Tauri] Updated Discord RPC:', title);
                    } catch (e) {
                        console.error('[Tauri] RPC Error:', e);
                    }
                }, 500);
            }
        });

        const iframe = document.getElementById('remote-frame');
        iframe.addEventListener('load', () => {
            const script = `
                (function() {
                    if (window.discordRpcInjected) return;
                    window.discordRpcInjected = true;

                    let observer = null;

                    function updateRPC(force = false) {
                        const titleEl = document.querySelector('.now-playing-bar .title');
                        const artistEl = document.querySelector('.now-playing-bar .artist');
                        const coverEl = document.querySelector('.now-playing-bar img.cover');
                        const audioEl = document.getElementById('audio-player');

                        if (titleEl && artistEl) {
                            let title = titleEl.innerText.replace(/\\s*HD\\s*$/, '').trim();
                            
                            let image = 'logo';
                            if (coverEl && coverEl.src && coverEl.src.startsWith('http') && coverEl.src.length < 256) {
                                image = coverEl.src;
                            }

                            const isPaused = audioEl ? audioEl.paused : false;
                            const currentSec = audioEl ? audioEl.currentTime : 0;

                            window.parent.postMessage({
                                type: 'UPDATE_DISCORD_RPC',
                                data: { title, artist: artistEl.innerText, image, isPaused, currentSec }
                            }, '*');
                        }
                    }

                    function attachAudioListeners() {
                        const audio = document.getElementById('audio-player');
                        if (audio && !audio.dataset.rpcAttached) {
                            audio.addEventListener('play', () => updateRPC(false));
                            audio.addEventListener('pause', () => updateRPC(false));
                            audio.addEventListener('seeked', () => updateRPC(true));
                            audio.dataset.rpcAttached = "true";
                        }
                    }

                    function initializeWatcher() {
                        const bar = document.querySelector('.now-playing-bar');
                        if (bar && !observer) {
                            observer = new MutationObserver(() => updateRPC(false));
                            observer.observe(bar, { subtree: true, childList: true, characterData: true });
                        }
                        attachAudioListeners();
                        updateRPC(false);
                    }


                    window.addEventListener('message', (event) => {
                        if (event.data.type === 'MEDIA_TOGGLE') {
                            const audio = document.getElementById('audio-player');
                            if (audio) {
                                if (audio.paused) audio.play(); else audio.pause();
                            }
                        }
                    });

                    setTimeout(() => {
                        initializeWatcher();
                        setInterval(initializeWatcher, 2000);
                    }, 1000);
                })();
            `;
            
            try {
                iframe.contentWindow.eval(script);
            } catch (e) {
                console.error('Failed to inject script:', e);
            }
        });
    </script>
</body>
</html>