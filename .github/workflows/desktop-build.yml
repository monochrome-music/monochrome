name: Desktop Build

on:
  push:
    branches: [main, neutralino]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            binary_source: Monochrome-win_x64.exe
            binary_dest: Monochrome.exe
            archive_name: monochrome-windows.zip
          - os: ubuntu-latest
            platform: linux
            binary_source: Monochrome-linux_x64
            binary_dest: Monochrome
            archive_name: monochrome-linux.zip
          - os: macos-latest
            platform: macos
            binary_source: Monochrome-mac_universal
            binary_dest: Monochrome
            archive_name: monochrome-mac.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Download Neutralino binaries
        run: bun x neu update

      - name: Build application
        run: bun run build

      - name: Prepare Release Folder
        run: |
          mkdir release
          if [ "${{ matrix.platform }}" = "macos" ]; then
            # Create .app bundle structure
            APP_DIR="release/Monochrome.app/Contents"
            mkdir -p "${APP_DIR}/MacOS" "${APP_DIR}/Resources"

            # Generate .icns icon
            ICONSET="Monochrome.iconset"
            mkdir -p "${ICONSET}"
            SOURCE_ICON="public/assets/1024.png"
            sips -z 16 16     "${SOURCE_ICON}" --out "${ICONSET}/icon_16x16.png"      > /dev/null 2>&1
            sips -z 32 32     "${SOURCE_ICON}" --out "${ICONSET}/icon_16x16@2x.png"   > /dev/null 2>&1
            sips -z 32 32     "${SOURCE_ICON}" --out "${ICONSET}/icon_32x32.png"      > /dev/null 2>&1
            sips -z 64 64     "${SOURCE_ICON}" --out "${ICONSET}/icon_32x32@2x.png"   > /dev/null 2>&1
            sips -z 128 128   "${SOURCE_ICON}" --out "${ICONSET}/icon_128x128.png"    > /dev/null 2>&1
            sips -z 256 256   "${SOURCE_ICON}" --out "${ICONSET}/icon_128x128@2x.png" > /dev/null 2>&1
            sips -z 256 256   "${SOURCE_ICON}" --out "${ICONSET}/icon_256x256.png"    > /dev/null 2>&1
            sips -z 512 512   "${SOURCE_ICON}" --out "${ICONSET}/icon_256x256@2x.png" > /dev/null 2>&1
            sips -z 512 512   "${SOURCE_ICON}" --out "${ICONSET}/icon_512x512.png"    > /dev/null 2>&1
            cp "${SOURCE_ICON}" "${ICONSET}/icon_512x512@2x.png"
            iconutil -c icns "${ICONSET}" -o "${APP_DIR}/Resources/Monochrome.icns"
            rm -rf "${ICONSET}"

            # Create Info.plist
            cat > "${APP_DIR}/Info.plist" <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleIdentifier</key>
              <string>com.monochrome.app</string>
              <key>CFBundleName</key>
              <string>Monochrome</string>
              <key>CFBundleDisplayName</key>
              <string>Monochrome</string>
              <key>CFBundleExecutable</key>
              <string>Monochrome</string>
              <key>CFBundleIconFile</key>
              <string>Monochrome</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          PLIST

            # Copy application files
            cp dist/Monochrome/${{ matrix.binary_source }} "${APP_DIR}/MacOS/Monochrome"
            cp neutralino.config.json "${APP_DIR}/MacOS/neutralino.config.json"
            cp dist/Monochrome/resources.neu "${APP_DIR}/MacOS/resources.neu"
            cp -r dist/Monochrome/extensions "${APP_DIR}/MacOS/extensions"
          else
            cp dist/Monochrome/resources.neu release/
            cp neutralino.config.json release/
            cp -r dist/Monochrome/extensions release/
            cp dist/Monochrome/${{ matrix.binary_source }} release/${{ matrix.binary_dest }}
            if [ "${{ matrix.platform }}" = "linux" ]; then
              cp scripts/linux-wayland-launcher.sh release/Monochrome-launcher
              cat > release/Monochrome.desktop <<'EOF'
          [Desktop Entry]
          Type=Application
          Version=1.0
          Name=Monochrome
          Comment=Monochrome music streaming app
          Exec=sh -c 'cd "$(dirname "%k")" && ./Monochrome-launcher --detach'
          Terminal=false
          Categories=Audio;Player;
          StartupNotify=true
          EOF
            fi
          fi
        shell: bash

      - name: Set Permissions (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          if [ "${{ matrix.platform }}" = "macos" ]; then
            chmod +x release/Monochrome.app/Contents/MacOS/Monochrome
          else
            chmod +x release/${{ matrix.binary_dest }}
            if [ "${{ matrix.platform }}" = "linux" ]; then
              chmod +x release/Monochrome-launcher
              chmod +x release/Monochrome.desktop
            fi
          fi

      - name: Zip for R2 (Windows)
        if: matrix.platform == 'windows'
        run: Compress-Archive -Path release/* -DestinationPath ${{ matrix.archive_name }} -Force
        shell: pwsh

      - name: Zip for R2 (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          cd release
          zip -r ../${{ matrix.archive_name }} .
        shell: bash

      - name: Isolate Zip File
        run: |
          mkdir out_delivery
          mv ${{ matrix.archive_name }} out_delivery/
        shell: bash

      - name: Upload to R2
        uses: ryand56/r2-upload-action@latest
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET }}
          source-dir: 'out_delivery'
          destination-dir: ''

      - name: Upload Artifact (GH Internal)
        uses: actions/upload-artifact@v4
        with:
          name: Monochrome-${{ matrix.platform }}
          path: release/
          retention-days: 30
